{% extends 'layout.html.twig' %}

{% block title %}Pager System{% endblock %}

{% block main %}
    <div class="send-message-form gap-4 p-4">
        <main class="send-message-form__container flex-grow-1 bg-body-secondary p-3">
            {{ form_start(form) }}
            <header class="row">
                <h1 class="h2-productive">Send Message</h1>
            </header>

            <div class="row">
                <div class="col-12 col-md-8 col-lg-6">
                    {{ form_label(form.message) }}
                    {{ form_widget(form.message, { 'attr': {'style': 'resize: none; height: 7rem;' } })}}
                    <div class="form-text text-muted">TODO Help text on length of message</div>
                </div>
                <div class="col-12 col-md">
                    {{ form_label(form.priority) }}
                    {{ form_widget(form.priority) }}
                </div>
            </div>

            <hr/>

            <div class="row mb-2 send-message-form__select-recipient-container" {{ stimulus_controller('send_message_select_recipient') }}
                 data-send-message-select-recipient-index-value="{{ form.to|length > 0 ? form.to|last.vars.name + 1 : 0 }}"
                    data-send-message-select-recipient-preselected-value="{{ form.to.vars.value|default([])|column('id')|json_encode() }}">
                <div class="col-4 end-border-arrow">
                    <div class="end-border-arrow__triangle"></div>
                    <div class="combobox" {{ stimulus_controller('send_message_search_recipient') }}
                        data-send-message-search-recipient-endpoint-value="{{ path('send_message_search_recipients') }}">
                        <label for="exampleFormControlInput1" class="form-label">To</label>
                        <input type="text" autocomplete="off" class="form-control" id="exampleFormControlInput1" placeholder="Search..." {{ stimulus_target('send_message_search_recipient', 'search') }} {{ stimulus_action('send_message_search_recipient', 'fetchOptions', 'keyup' ) }}>
                        {{ form_widget(form.optionsTo, { attr: stimulus_target('send_message_search_recipient', 'optionsList')|stimulus_target('send_message_select_recipient', 'optionsList')|stimulus_action('send_message_select_recipient', 'addSelectedRecipient', 'dblclick')|stimulus_action('send_message_select_recipient', 'addSelectedRecipients', 'keydown.enter').toArray() }) }}
                        {# TODO Options preselected not marked green #}
                        <p class="show-parent-mo form-text text-muted mb-0">Double-click option to select!</p>
                        <p class="show-parent-focus form-text text-muted mb-0">Press enter to select!</p>
                    </div>
                </div>

                <div class="col-8">
                    <label class="form-label">Selected</label>

                    <div class="bg-body border rounded overflow-scroll send-message-form__selected">
                        {# TODO Fixed Header / Scroll Body Only #}

                        <table class="table table-sm table-hover" style="background: none">
                            <thead>
                            <tr>
                                <th class="p-0"><!--Hidden Form Field--></th>
                                <th scope="col" class="fixw-2_4rem"><!--Remove Button--></th>
                                <th scope="col">Recipient</th>
                                <th scope="col" class="text-end px-2">Channel</th>
                            </tr>
                            </thead>
                            <tbody {{ stimulus_target('send_message_select_recipient', 'collectionContainer') }}>
                            <template {{ stimulus_target('send_message_select_recipient', 'template') }}>
                                <tr>
                                    <td class="p-0">{{ form_widget(form.to.vars.prototype) }}</td>
                                    <td class="px-2 fixw-2_4rem">
                                        <button title="Remove" class="btn btn-sm-table btn-outline-danger" type="button"
                                                {{ stimulus_action('send_message_select_recipient', 'removeSelected') }}>
                                            <
                                        </button>
                                    </td>
                                    <td>__LABEL__</td>
                                    <td class="text-end px-2">Mail</td>
                                </tr>
                            </template>
                            {% do form.to.setRendered %}
                            {% for field in form.to %}
                                    <tr>
                                        <td class="p-0">
                                            {{ form_widget(field) }}
                                        </td>
                                        <td class="px-2 fixw-2_4rem">
                                            <button title="Remove" class="btn btn-sm-table btn-outline-danger" type="button"
                                                    {{ stimulus_action('send_message_select_recipient', 'removeSelected') }}>
                                                <
                                            </button>
                                        </td>
                                        <td>{{ field.label.vars.value }}</td>
                                        <td class="text-end px-2">
                                            <twig:ux:icon name="bi:telephone-fill" height="1em" />
                                            <twig:ux:icon name="bi:at" height="1em" />
                                            <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 512 512"><path fill="currentColor" d="M0 128c0-35.3 28.7-64 64-64h384c35.3 0 64 28.7 64 64v256c0 35.3-28.7 64-64 64H64c-35.3 0-64-28.7-64-64zm64 32v64c0 17.7 14.3 32 32 32h320c17.7 0 32-14.3 32-32v-64c0-17.7-14.3-32-32-32H96c-17.7 0-32 14.3-32 32m16 160c-13.3 0-24 10.7-24 24s10.7 24 24 24h56c13.3 0 24-10.7 24-24s-10.7-24-24-24zm136 0c-13.3 0-24 10.7-24 24s10.7 24 24 24h48c13.3 0 24-10.7 24-24s-10.7-24-24-24z"/></svg>
                                        </td>
                                    </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {{ form_errors(form) }}
            <footer class="mt-3 d-flex justify-content-between">
                {{ form_widget(form.save) }}
                {{ form_widget(form.reset) }}
            </footer>
            {{ form_end(form) }}
        </main>

        <aside class="bg-body-tertiary p-3 d-none d-xl-block">
            <h3 class="mb-3 h3-productive">Predefined Messages</h3>
            <div class="border p-2 px-4 fw-bold mb-2">
                Fire
            </div>
            <div class="border p-2 px-4 fw-bold mb-2">
                Weather Report
            </div>
            <div class="border p-2 px-4 fw-bold mb-2">
                Team Meeting
            </div>
        </aside>
    </div>

    <div class="mx-4 mb-5">
        <h2 class="h2-productive ">
            <twig:ux:icon name="bi:clock-history" height="21" width="21" aria-hidden="true" class="bi"/>
            Sent Messages</h2>
        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead>
                <tr>
                    <th scope="col">Zeitstempel</th>
                    <th scope="col">An</th>
                    <th scope="col">Nachricht</th>
                    <th scope="col">Priorit√§t</th>
                    <th scope="col">Status</th>
                </tr>
                </thead>
                <tbody class="table-group-divider">
                {% for message in messageLog %}
                    <tr>
                        <td>{{ message.sentOn|date("d.m.y H:i") }}</td>
                        <td>
                            {% for r in message.sentTo %}
                                {{ component('RecipientWithId', { id: r }) }}
                            {% endfor %}
                        </td>
                        <td> {{ message.content }} </td>
                        <td>{{ message.priority }}</td>
                        <td>{{ message.status }}</td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
{% endblock %}